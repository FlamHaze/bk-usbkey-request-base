!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).bkUsbkeyReqBase=t()}(this,function(){"use strict";var d="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}var f=t(function(e,t){t.__esModule=!0,t.removeElementsByName=t.elementRemoveEvent=t.elementAddEvent=t.getElementsByClassName=void 0,t.getElementsByClassName=function(e){for(var t=document.getElementsByTagName("*"),n=t.length,o=[],r=0;r<n;r++){var a=t[r].className||"";if(!(a.indexOf(e)<0))for(var d=a.split(/\s+/),s=d.length,i=0;i<s;i++)e==d[i]&&o.push(t[r])}return o},t.elementAddEvent=function(e,t,n){e.saveEventHandle||(e.saveEventHandle=[]),e.saveEventHandle[t]=n,window.addEventListener?e.addEventListener(t,e.saveEventHandle[t],!1):window.attachEvent?e.attachEvent("on"+t,e.saveEventHandle[t]):e["on"+t]=e.saveEventHandle[t]},t.elementRemoveEvent=function(e,t){var n=e.saveEventHandle?e.saveEventHandle[t]:void 0;n&&(window.addEventListener?e.removeEventListener(t,n,!1):window.detachEvent?e.detachEvent("on"+t,n):e["on"+t]="")},t.removeElementsByName=function(e){for(var t=document.getElementsByName(e),n=t.length-1;0<=n;n--)try{document.body.removeChild(t[n])}catch(e){}}});e(f),f.removeElementsByName,f.elementRemoveEvent,f.elementAddEvent,f.getElementsByClassName;var n=t(function(e,t){var o,n=d&&d.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});t.__esModule=!0;var r,n=(r=Error,n(a,r),a);function a(e){var t=r.call(this,e.message)||this;return t.name="CrossFormRequestSendError",t.code=e.code,t.errNameSign=e.errNameSign,t.successLength=e.successLength,t.totalOperateLength=e.totalOperateLength,t.jsonData=e.jsonData,t.strData=e.strData,t}t.default=n});e(n);var _=t(function(e,t){t.__esModule=!0,t.createCrossResponseError=void 0,t.createCrossResponseError=function(e){return new n.default(e)}});e(_),_.createCrossResponseError;var s=t(function(e,d){d.__esModule=!0,d.operateForm=d.operate=d.addForm=d.subOneFormCalc=d.addFormCalc=d.addIframe=d.FORM_NAME_PRE=d.FORM_CLASSNAME=d.IFRAME_NAME=d.IFRAME_ID=void 0;var o="BK_CROSS_FORM_REQUEST_FORM_CALC_ID",c="BK_CROSS_FORM_REQUEST_FORM_OPERATE_STATE_ID";d.IFRAME_ID="BK_CROSS_FORM_REQUEST_IFRAME_ID",d.IFRAME_NAME="BK_CROSS_FORM_REQUEST_IFRAME_NAME",d.FORM_CLASSNAME="BK_CROSS_FORM_REQUEST_FORM_CLASSNAME",d.FORM_NAME_PRE="BK_CROSS_FORM_REQUEST_FORM_NAME";var E="name-sign",u="BK_CROSS_FORM_REQUEST_FORM_REQUEST_TIMEOUT_FLAG";function s(){var e=document.getElementById(o);if(e){var t=parseInt(e.value);return e.value=t+1,t+1}t=document.createElement("input");return t.id=o,t.style.display="none",t.value="1",document.body.appendChild(t),1}function i(e,t,n){return r(e=void 0===e?function(){return!1}:e,t,n=void 0===n?!0:n)}function r(r,a,e,t){void 0===r&&(r=function(){return!1}),void 0===t&&(t={length:0});var n=document.getElementById(d.IFRAME_ID);if(!n)return new Promise(function(e,t){t(_.createCrossResponseError({code:"NO_REQUEST_TARGET_IFRAME",message:"目标iframe有可能已被删除,请刷新页面后重新尝试"}))});if(document.getElementById(c))return e?new Promise(function(t,n){var o=setInterval(function(){var e=i(r,a,!1);null!=e&&(clearInterval(o),e.then(function(e){t(e)}).catch(function(e){console.log("内部异常"),n(e)}))},1e3)}):null;e=document.createElement("div");return e.style.display="none",e.id=c,document.body.appendChild(e),function(s,i,e,u,m){var t=function(e){return document.getElementsByName(e)}(s),n=t.length;if(n<=0)return document.body.removeChild(e),null;var l=[];if(1==n)t[0].target=i.name,l.push(t[0]);else{for(var o=0;o<n;o++)t[o].target=i.name,l.push(t[o]);l.sort(function(e,t){e=parseInt(e.getAttribute("index")),t=parseInt(t.getAttribute("index"));return t<e?1:e==t?0:-1})}return new Promise(function(r,a){var d=void 0;f.elementRemoveEvent(window,"message"),f.elementAddEvent(window,"message",function(e){d&&clearTimeout(d);var t,n,o=e.data;if("string"==typeof o){t=o;try{n=JSON.parse(o)}catch(e){n=void 0}}else{try{t=JSON.stringify(o)}catch(e){t=void 0}n=o}o=i.getAttribute(E);if("function"==typeof m&&m(n,t))return f.removeElementsByName(s),f.elementRemoveEvent(window,"message"),document.body.removeChild(document.getElementById(c)),void a(_.createCrossResponseError({code:"CUSTOM_ERROR",message:"响应数据处理错误！",jsonData:n,strData:t,errNameSign:o,successLength:u.length,totalOperateLength:l.length+u.length+1}));u.length+=1,u[o]={name:o,data:{jsonData:n,strData:t}},0<l.length?d=v(i,l,u.length,a):(f.elementRemoveEvent(window,"message"),document.body.removeChild(document.getElementById(c)),r(u))}),d=v(i,l,0,a)})}(a,n,e,t,r)}d.addIframe=function(){var e,t=document.getElementById(o);if(e=t?(n=parseInt(t.value),""+d.FORM_NAME_PRE+n):d.FORM_NAME_PRE+"0",document.getElementById(d.IFRAME_ID))return e;var t=document.body,n=l("iframe",d.IFRAME_NAME);return n.id=d.IFRAME_ID,n.name=d.IFRAME_NAME,n.style.display="none",t.appendChild(n),e},d.addFormCalc=s,d.subOneFormCalc=function(){var e,t=document.getElementById(o);t&&(0!=(e=parseInt(t.value))?t.value=e-1:document.body.removeChild(t))},d.addForm=function(e,t){var n,o,r=l("form",t);for(n in r.action=e.url,r.method=e.method.toUpperCase(),r.style.display="none",e.data)"crosFlag"!=n&&((o=l("input",n)).name=n,o.value=e.data[n],r.appendChild(o));var a=l("input","crosFlag");a.name="crosFlag",a.value="1",r.appendChild(a),r.className=d.FORM_CLASSNAME,r.name=t,r.setAttribute(E,e.nameSign),r.setAttribute("index",s().toString()),r.setAttribute(u,e.timeOut.toString()),document.body.appendChild(r)},d.operate=i,d.operateForm=r;var v=function(e,t,n,o){var r,a=t.splice(0,1),d=a[0].getAttribute(E),s=a[0].getAttribute(u),i=a[0].name;try{r=parseInt(s)}catch(e){r=5e3}o=m(r,i,d,n,n+t.length+1,o);return e.setAttribute(E,d),a[0].submit(),document.body.removeChild(a[0]),o},m=function(e,t,n,o,r,a){if(!(e<=0)){var d=setTimeout(function(){clearTimeout(d),f.removeElementsByName(t),f.elementRemoveEvent(window,"message"),document.body.removeChild(document.getElementById(c));var e={code:"REQUEST_TIMEOUT",msg:"客户端访问超时"};a(_.createCrossResponseError({code:e.code,message:e.msg,errNameSign:n,strData:JSON.stringify(e),jsonData:e,successLength:o,totalOperateLength:r}))},e);return d}};function l(e,t){return window.ActiveXObject||"ActiveXObject"in window?document.createElement("<"+e+' name="'+t+'"></'+e+">"):document.createElement(e)}});return e(s),s.operateForm,s.operate,s.addForm,s.subOneFormCalc,s.addFormCalc,s.addIframe,s.FORM_NAME_PRE,s.FORM_CLASSNAME,s.IFRAME_NAME,s.IFRAME_ID,e(t(function(e,t){t.__esModule=!0,t.default=function(e,t){var n=s.addIframe();if(e instanceof Array){for(var o,r=0;r<e.length;r++)if(o=a(e[r],n))return o}else if(o=a(e,n))return o;return s.operate(t,n)};var a=function(e,t){if(!e.nameSign)return f.removeElementsByName(t),new Promise(function(e,t){t(_.createCrossResponseError({code:"ERR_nameSign",message:"未找到正确的方法签名"}))});e.method=e.method||"post",e.timeOut=e.timeOut||5e3,s.addForm(e,t)}}))});
